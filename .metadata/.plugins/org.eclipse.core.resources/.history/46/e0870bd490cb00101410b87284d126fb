package com.klef.fsd.sdp.hotelhub.service;

import com.klef.fsd.sdp.hotelhub.model.*;
import com.klef.fsd.sdp.hotelhub.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.List;
import java.util.Optional;

@Service
public class ManagerServiceImpl implements ManagerService {

    @Autowired private ManagerRepository managerRepository;
    @Autowired private RoomRepository roomRepository;
    @Autowired private BookingRepository bookingRepository;
    @Autowired private FoodItemRepository foodItemRepository;
    @Autowired private CabRepository cabRepository;
    @Autowired private CabBookingRepository cabBookingRepository;

    // Auth
    @Override public Manager checkManagerLogin(String u, String p) { return managerRepository.findByUsernameAndPassword(u, p); }

    // --- Room Management (FIXED HERE) ---
    @Override 
    public String addRoom(Room room) { 
        // 1. Check if manager ID is present
        if (room.getManager() != null) {
            int mid = room.getManager().getId();
            // 2. Fetch the full Manager object from DB
            Optional<Manager> m = managerRepository.findById(mid);
            if (m.isPresent()) {
                // 3. Attach the real manager to the room
                room.setManager(m.get());
                roomRepository.save(room); 
                return "Room added successfully."; 
            }
        }
        throw new RuntimeException("Manager not found");
    }

    @Override 
    public String updateRoom(Room room) { 
        // Same logic for update to be safe
        if (room.getManager() != null) {
            int mid = room.getManager().getId();
            Optional<Manager> m = managerRepository.findById(mid);
            if (m.isPresent()) {
                room.setManager(m.get());
                roomRepository.save(room); 
                return "Updated."; 
            }
        }
        return "Error updating room.";
    }

    @Override public String deleteRoom(int id) { roomRepository.deleteById(id); return "Deleted."; }
    @Override public List<Room> viewAllRoomsByManager(int id) { return roomRepository.findByManagerId(id); }
    @Override public Room getRoomById(int id) { return roomRepository.findById(id).orElse(null); }
    @Override public List<Booking> viewBookingsForManager(int id) { return bookingRepository.findByManagerId(id); }

    // Food
    public FoodItem addFoodItem(FoodItem item) { return foodItemRepository.save(item); }
    public List<FoodItem> viewFoodMenu(int mid) { return foodItemRepository.findByManagerId(mid); }
    public void deleteFoodItem(int id) { foodItemRepository.deleteById(id); }

    // Cab Management
    public Cab addCab(Cab cab) { return cabRepository.save(cab); }
    public List<Cab> viewMyCabs(int mid) { return cabRepository.findByManagerId(mid); }
    public void deleteCab(int id) { cabRepository.deleteById(id); }

    // Cab Requests
    public List<CabBooking> viewCabRequests(int managerId) {
        return cabBookingRepository.findByManagerId(managerId);
    }

    public String updateCabStatus(int bookingId, String status) {
        CabBooking cb = cabBookingRepository.findById(bookingId).orElse(null);
        if(cb != null) {
            cb.setStatus(status);
            cabBookingRepository.save(cb);
            return "Status Updated";
        }
        return "Booking Not Found";
    }
}